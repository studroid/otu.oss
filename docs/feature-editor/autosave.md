# 에디터 자동저장 및 자동 제목 생성

## 개요

페이지 에디터는 사용자의 편집 내용을 자동으로 저장하고, AI를 활용하여 자동으로 제목을 생성합니다. 이 문서는 에디터의 핵심 자동화 기능을 설명합니다.

## 에디터 구조

### BlockNote 에디터

**라이브러리**: BlockNote 0.44.0

- 오픈소스 블록 기반 에디터
- Notion 스타일의 편집 경험 제공
- 다국어 지원 (한국어/영어)

**주요 기능**:

- 블록 단위 편집 (텍스트, 이미지, 코드 블록 등)
- 슬래시 명령어 (`/`)로 블록 삽입
- AI 기능 통합 (번역, 요약, 개선 등)
- 드래그 앤 드롭 이미지 업로드
- 마크다운 단축키 지원

### 컴포넌트 구조 (home2 - 신규)

- **EditorContainer** (`EditorContainer.tsx`): 에디터 최상위 컨테이너
    - 라우팅 및 레이아웃 관리
- **PageEditor** (`PageEditor.tsx`): 에디터 메인 컴포넌트
    - BlockNote 에디터 초기화
    - 제목/본문 상태 관리
- **useEditorState** (`hooks/useEditorState.ts`): 에디터 상태 관리 훅
    - 수정 감지, 상태 동기화
- **useAutoSave** (`hooks/useAutoSave.ts`): 자동저장 전용 훅
    - Debounce 처리
    - 재시도 메커니즘

## 자동저장 시스템

### 트리거 조건

**저장이 실행되는 경우**:

1. 에디터 내용 변경 후 3초 경과 (debounce)
2. 제목 변경 후 3초 경과
3. 사용자가 수동으로 저장 버튼 클릭

**저장이 실행되지 않는 경우**:

- 연속 편집 중 (타이핑 중)
- 이미 저장 중인 경우
- 수정사항이 없는 경우 (`isModified === false`)

### Debounce 메커니즘

**설정**: 3초 간격 (`autoSaveInterval: 3000ms`)

**동작 방식**:

```
사용자 입력 → 3초 대기 → 추가 입력 없음 → 저장 실행
사용자 입력 → 3초 대기 → 추가 입력 발생 → 대기 시간 초기화
```

**안정화 기법**:

- `useRef`로 debounce 함수 관리 (함수 재생성 방지)
- `submitHandlerRef`로 최신 저장 함수 참조 유지
- `isModifiedRef`로 최신 수정 상태 참조

### 재시도 메커니즘

**재시도 조건**: 저장 실패 시 자동 재시도

**설정**:

- 최대 재시도 횟수: 3회 (`MAX_RETRY_COUNT`)
- 재시도 간격: 5초
- 모든 재시도 실패 시 사용자에게 오류 알림

**재시도 흐름**:

```
저장 시도 → 실패 → 5초 후 재시도 (1/3)
             → 실패 → 5초 후 재시도 (2/3)
             → 실패 → 5초 후 재시도 (3/3)
             → 실패 → 오류 메시지 표시
```

### 저장 버튼 표시

**렌더링 조건** (다음 중 하나라도 충족):

- 본문에 텍스트가 있음 (`bodyLength > 0`)
- 수정사항이 있음 (`isModified === true`)
- 제목이 있음 (`title && title.trim() !== ''`)

**상태별 UI**:

- **저장 중**: 로딩 아이콘 + "저장 중" 텍스트
- **미저장**: "저장되지 않음" 텍스트
- **저장됨**: 체크 아이콘 + "저장됨" 텍스트

## 자동 제목 생성 시스템

### 트리거 조건

**모든 조건을 충족해야 실행**:

1. 본문이 100글자 이상
2. 제목이 비어있음
3. 아직 자동 제목을 생성하지 않음 (`hasAutoGeneratedTitle === false`)
4. 제목 로딩 중이 아님 (`isTitleLoading === false`)
5. 쿨다운 기간 경과 (10초)
6. 로그인한 사용자 (익명 사용자 제외)

### 사용자 타입별 처리

**익명 사용자**:

- 자동 제목 생성 안 함
- 저장 시 기본 제목 사용 ("제목 없음" 또는 본문 첫 줄)

**로그인 사용자**:

- AI를 통한 자동 제목 생성
- API: `/api/ai/titling`

### 제목 생성 프로세스

1. **트리거**: 본문이 100글자를 넘어가는 순간
2. **API 호출**: `fetchTitling(pageId, body)`
3. **제목 설정**: AI가 생성한 제목으로 자동 설정
4. **플래그 설정**: `hasAutoGeneratedTitle = true`
5. **재생성 방지**: 같은 페이지에서 한 번만 실행

### 플래그 초기화

**자동 제목 플래그 초기화 시점**:

- 새 페이지로 전환
- 사용자가 제목을 수동으로 변경

**페이지별 제목 생성 플래그**:

- `titleGeneratedForPageRef`: 페이지 ID별로 제목 생성 여부 추적
- 같은 페이지를 다시 열어도 재생성하지 않음

## 통합 워크플로우

### 시나리오 1: 새 페이지 작성

```
1. 페이지 열기
   ↓
2. 플래그 초기화
   - hasAutoGeneratedTitle = false
   - hasTriggeredEmbedding = false
   ↓
3. 타이핑 시작 (50글자)
   - 자동저장 대기 (3초 debounce)
   ↓
4. 계속 타이핑 (100글자 초과)
   - 자동 제목 생성 시작
   - 자동저장 debounce 재설정
   ↓
5. 타이핑 멈춤
   - 3초 후 자동저장 실행
   ↓
6. 페이지 닫기
   - 자동저장 완료 확인
```

### 시나리오 2: 기존 페이지 수정

```
1. 페이지 열기 (제목/본문 있음)
   ↓
2. 본문 수정
   - isModified = true
   - 자동저장 대기 (3초 debounce)
   ↓
3. 수정 멈춤
   - 3초 후 자동저장 실행
   - isModified = false
   ↓
4. 제목 수정
   - hasAutoGeneratedTitle = false (플래그 초기화)
   - 자동저장 대기
```

### 시나리오 3: 연속 편집

```
1. 타이핑 시작
   ↓
2. 자동저장 debounce 시작 (3초)
   ↓
3. 2초 후 추가 입력
   ↓
4. Debounce 재설정 (다시 3초 대기)
   ↓
5. 1초 후 추가 입력
   ↓
6. Debounce 재설정 (다시 3초 대기)
   ↓
7. 타이핑 완전 멈춤
   ↓
8. 3초 후 저장 실행
```

## 성능 최적화

### HTML 변환 최적화

**문제**: 매번 HTML 변환은 성능 부담

**해결**:

- 텍스트 길이 계산 시 BlockNote document를 직접 순회
- HTML 변환 없이 플레인 텍스트 길이만 계산 (`calculatePlainTextLength`)
- 저장할 때만 HTML 변환 (`convertBlockNoteToHTML`)

### Debounce 안정화

**문제**: `useCallback` 의존성 변경 시 debounce 함수 재생성

**해결**:

- `useRef`로 debounce 함수 관리
- `submitHandlerRef`로 최신 함수 참조 유지
- 의존성 배열에서 debounce 함수 제거

### 메모이제이션

**컴포넌트 메모**:

- `EditorUI` 컴포넌트: `memo`로 불필요한 재렌더링 방지
- `HeaderArea` 컴포넌트: `memo` + `useMemo`로 최적화

**번역 텍스트 메모**:

```typescript
const translations = useMemo(
    () => ({
        saving: t('saving'),
        saved: t('saved'),
        unsaved: t('unsaved'),
    }),
    [t]
);
```

## 관련 파일

### 에디터 컴포넌트 (home2 - 신규)

- **컨테이너**: `src/components/home2/editor/EditorContainer.tsx`
- **페이지 에디터**: `src/components/home2/editor/PageEditor.tsx`
- **컨트롤**: `src/components/home2/editor/components/EditorControls.tsx`

### 에디터 훅 (home2 - 신규)

- **자동저장**: `src/components/home2/editor/hooks/useAutoSave.ts`
- **에디터 상태**: `src/components/home2/editor/hooks/useEditorState.ts`
- **페이지 저장**: `src/components/home2/editor/hooks/usePageSave.ts`
- **페이지 데이터**: `src/components/home2/editor/hooks/usePageData.ts`
- **키보드 단축키**: `src/components/home2/editor/hooks/useKeyboardShortcuts.ts`

### 레거시 에디터 (home - 마이그레이션 중)

- **메인 로직**: `src/components/home/logined/page/CreateUpdate/useCreate.tsx`
- **헤더 영역**: `src/components/home/logined/page/CreateUpdate/components/HeaderArea.tsx`

### BlockNote 관련

- **래퍼**: `src/components/common/BlockNoteEditor/BlockNoteWrapper.tsx`
- **유틸리티**: `src/components/common/BlockNoteEditor/utils.ts`
- **슬래시 메뉴**: `src/components/common/BlockNoteEditor/slashMenu.ts`

### API

- **자동 제목 생성**: `app/api/ai/titling/route.ts`
- **제목 생성 함수**: `src/functions/ai.js` (`fetchTitling`)

## 디버깅

### 로거

- **에디터 뷰**: `editorViewLogger` (`src/debug/editor`)
- **BlockNote**: `editorBlockNoteLogger` (`src/debug/editor`)

### 디버깅 활성화

```typescript
// 브라우저 콘솔
localStorage.debug = 'editor';
```

### 주요 로그 포인트

- 자동저장 트리거 및 완료
- 자동 제목 생성 조건 체크
- Debounce 실행 및 취소
- 재시도 횟수 및 오류

## 관련 문서

- [AI 채팅 RAG 모드](../feature-chat/rag-modes.md): 저장된 페이지의 임베딩이 AI 채팅 검색에 활용되는 방식
