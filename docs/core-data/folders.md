# 폴더 시스템 메커니즘

## 데이터베이스 구조

1. **folder 테이블**:

    - `id`: ULID 기반 고유 식별자
    - `user_id`: 폴더 소유자 ID (RLS로 접근 제어)
    - `name`: 폴더명
    - `description`: 폴더 설명
    - `thumbnail_url`: 썸네일 URL
    - `page_count`: 페이지 수 (트리거로 자동 업데이트)
    - `last_page_added_at`: 마지막 페이지 추가 시간
    - `created_at`, `updated_at`: 생성/수정 시간

2. **page 테이블 확장**:
    - `folder_id`: 페이지가 속한 폴더 ID (NULL 가능)
    - 폴더 삭제 시 folder_id는 NULL로 설정

## WatermelonDB 기반 오프라인 우선 아키텍처

1. **로컬 우선 처리**:

    - 모든 폴더 작업(생성, 수정, 삭제, 할당)은 WatermelonDB에서 즉시 처리
    - 사용자는 동기화 완료를 기다리지 않고 즉시 결과를 확인할 수 있음
    - 네트워크 상태와 무관하게 오프라인에서도 작업 가능

2. **백그라운드 동기화 메커니즘**:

    - 폴더 작업 완료 후 `triggerSync()` 함수가 호출됨
    - 동기화는 Promise 체인으로 백그라운드에서 비동기 실행
    - `await` 없이 호출하여 사용자 인터페이스 차단 없음
    - 동기화 성공/실패는 로깅으로만 기록하고 사용자 작업에 영향 주지 않음

3. **성능 최적화**:
    - 폴더 선택 시 즉시 반영 (기존 지연 문제 해결)
    - 로컬 데이터베이스 조회로 빠른 응답성 제공
    - 네트워크 지연이나 서버 문제가 사용자 경험에 영향 주지 않음

## 자동 업데이트 시스템

1. **트리거 기반 업데이트**:

    - PostgreSQL 트리거를 통해 페이지 추가/제거 시 폴더의 `page_count` 자동 업데이트
    - 클라이언트에서 별도의 페이지 수 계산 로직 불필요

2. **썸네일 자동 선택**:

    - 폴더에 속한 페이지 중 이미지가 있는 첫 번째 페이지의 이미지를 썸네일로 설정
    - 이미지가 없으면 빈 문자열로 설정

3. **폴더 정보 동기화**:
    - `syncFolderInfoSilent()`: 로컬에서만 폴더 정보 업데이트 (동기화 트리거 없음)
    - `syncFolderInfo()`: 폴더 정보 업데이트 후 서버 동기화 트리거
    - 변경사항이 있을 때만 실제 동기화 수행하여 불필요한 네트워크 요청 방지

## 다중 페이지 처리 최적화

1. **배치 처리 메커니즘**:

    - 다중 페이지를 폴더에 추가할 때 개별 페이지마다 동기화하지 않음
    - `addPagesToFolder()` 함수로 모든 로컬 작업 완료 후 한 번만 동기화
    - 영향받은 폴더들을 Set으로 수집하여 중복 처리 방지

2. **동기화 제어**:

    - `shouldTriggerSync` 매개변수로 개별 함수의 동기화를 선택적으로 제어
    - 배치 처리 시에는 마지막에만 동기화 트리거하여 서버 부담 최소화
    - 로컬 작업과 서버 동기화를 분리하여 사용자 경험 향상

3. **성능 최적화**:
    - 다중 선택 시 `Promise.all()` 대신 배치 전용 함수 사용
    - 폴더 정보 업데이트를 한 번에 처리하여 데이터베이스 접근 최소화
    - 불필요한 중복 동기화 방지로 네트워크 트래픽 감소

## 페이지-폴더 관계 관리

1. **참조 무결성 보장**:

    - 폴더 삭제 시 해당 폴더를 참조하는 모든 페이지들의 folder_id를 null로 설정
    - 고아 페이지(orphan pages) 방지
    - 데이터베이스 외래키 제약조건과 동일한 효과를 WatermelonDB에서 구현

2. **로깅 및 디버깅**:
    - 폴더 삭제 과정과 페이지 정리 과정을 상세히 로깅
    - 문제 발생 시 빠른 원인 파악 가능
    - 로그 레벨: `DEBUG='folder'`로 확인 가능

## 보안 및 데이터 일관성

1. **RLS(Row Level Security) 정책**:

    - 폴더: 소유자(`user_id`)만 CRUD 가능
    - 페이지: 기존 RLS 정책과 연동하여 일관성 유지

2. **데이터 무결성**:
    - 외래 키 제약으로 참조 무결성 보장
    - 트리거로 메타데이터 실시간 동기화
    - 폴더 삭제 시 페이지는 독립 상태로 유지

## WatermelonDB 동기화

1. **클라이언트 동기화**:

    - `Folder` 모델 클래스로 폴더 데이터 관리
    - `Page` 모델에 `folder_id` 필드 추가
    - 서버-클라이언트 간 일관된 데이터 구조

2. **스키마 설정**:
    - 현재 스키마 버전: 1 (오픈소스 버전 통합)
    - 폴더 시스템은 초기 스키마에 포함됨

## 사용자 경험 최적화

1. **폴더 표시 UI**:

    - 제목 영역에 폴더가 있는 경우만 폴더 칩 표시
    - 작은 크기와 적절한 색상으로 방해하지 않는 디자인

2. **폴더 설정 버튼**:

    - 에디터 툴바에 폴더 아이콘 버튼 추가
    - 페이지가 존재하는 경우에만 표시
    - Motion 효과로 자연스러운 사용자 경험

3. **직관적인 폴더 관리**:
    - 현재 페이지 폴더 상태 명확히 표시
    - 드래그 앤 드롭 없이도 간단한 클릭으로 폴더 할당
    - 폴더 생성과 페이지 할당을 한 번에 처리 가능
