# 데이터 동기화 메커니즘

> WatermelonDB 기반 오프라인 우선 동기화 시스템

**위치**: `src/watermelondb/sync.ts`

## 개요

오프라인에서도 앱을 사용할 수 있도록 로컬 데이터베이스(WatermelonDB)와 서버(Supabase)를 동기화합니다. 사용자가 여러 기기에서 동일한 데이터를 볼 수 있도록 보장합니다.

### 핵심 특징

- **오프라인 우선**: 네트워크 없이도 모든 기능 사용 가능
- **증분 동기화**: 변경된 데이터만 전송하여 효율성 향상
- **동시성 제어**: 여러 동기화 요청을 순차 처리하여 충돌 방지
- **자동 복구**: 네트워크 오류 시 자동 재시도

## 동기화 흐름

### 1. Pull (서버 → 로컬)

서버에서 변경된 데이터를 로컬로 가져옵니다.

```
[서버] → [API] → [로컬 DB]
```

**프로세스**:

1. 마지막 동기화 시각(`lastPulledAt`) 이후 변경사항 조회
2. `created`, `updated`, `deleted` 데이터 수신
3. 로컬 DB에 적용 (생성/수정/삭제)
4. `lastPulledAt` 업데이트

**증분 동기화**:

- 최초: 모든 데이터 다운로드
- 이후: 변경분만 다운로드 (타임스탬프 기반)

### 2. Push (로컬 → 서버)

로컬에서 생성/수정/삭제한 데이터를 서버에 업로드합니다.

```
[로컬 DB] → [API] → [서버]
```

**프로세스**:

1. 로컬에서 `synced = false`인 레코드 수집
2. 서버로 전송 (created/updated/deleted 구분)
3. 서버에서 저장 성공 시 로컬 레코드를 `synced = true`로 마킹

## 동시성 제어

여러 동기화 요청이 동시에 발생하면 충돌이 발생할 수 있습니다. 이를 방지하기 위해 **2단계 제어**를 사용합니다.

### 클라이언트 레벨 (useSync.tsx)

```
동기화 요청 → 진행 중? → [예] 즉시 거부
                       → [아니오] 실행
```

- `isSyncingRef`로 진행 중 상태 확인
- 이미 진행 중이면 새 요청 즉시 거부
- 대기열 없음 (빠른 응답)
- debounce(2000ms)로 중복 요청 방지 (leading+trailing)

### 서버 레벨 (sync.ts)

```
동기화 요청 → 진행 중? → [예] 현재 Promise 반환
                       → [아니오] 실행
```

- `isSyncing` 플래그로 진행 중 상태 관리
- 이미 진행 중이면 현재 `currentSyncPromise` 반환 (대기열 없음)
- 같은 동기화 결과를 공유하여 중복 요청 방지

## 자동 동기화 트리거

다음 이벤트 발생 시 자동으로 동기화가 실행됩니다:

1. **온라인 복귀**: `window 'online'` 이벤트
2. **탭 포커스**: `window 'focus'` 이벤트
3. **페이지 가시성**: `document 'visibilitychange'` 이벤트
4. **주기적 동기화**: 30분 간격
5. **앱 시작**: 컴포넌트 마운트 시 1ms 후

## 데이터 무결성

### checkSync (일관성 검증)

로컬과 서버 데이터가 일치하는지 확인합니다.

- **주기**: 앱 시작 시, 동기화 완료 후
- **방법**: 각 테이블의 레코드 개수 비교
- **불일치 시**: Sentry 경고 (선택적 기능, `NEXT_PUBLIC_ENABLE_SENTRY=true` 시 활성화) + 사용자 알림

### FailOver (자동 복구)

동기화 실패 시 자동으로 재시도합니다.

- **트리거**: 네트워크 오류, 타임아웃
- **재시도**: 최대 3회, 지수 백오프
- **최종 실패 시**: 사용자에게 알림

## 초기 동기화 vs 증분 동기화

### 초기 동기화

- **시점**: 첫 로그인, 데이터 초기화 후
- **특징**:
    - 모든 데이터 다운로드
    - `lastPulledAt = null`
    - 시간이 오래 걸림 (수십 초)
- **UI**: 로딩 화면 표시

### 증분 동기화

- **시점**: 이후 모든 동기화
- **특징**:
    - 변경분만 다운로드
    - `lastPulledAt` 이후 변경사항만 조회
    - 빠름 (수 초)
- **UI**: 백그라운드 실행, 진행 표시줄 선택적

## 성능 최적화

### 배치 처리

- 한 번에 여러 레코드를 처리하여 네트워크 요청 최소화
- 기본 배치 크기: 100개

### 페이지네이션

- 대량 데이터는 페이지 단위로 처리
- 메모리 사용량 제한

### 압축

- 네트워크 전송 시 gzip 압축 사용

## API 엔드포인트

### `/api/sync/pull`

- **메서드**: POST
- **역할**: 서버에서 변경사항 가져오기
- **요청**: `lastPulledAt`
- **응답**: `changes` (pull 데이터), `timestamp`

### `/api/sync/push`

- **메서드**: POST
- **역할**: 로컬 변경사항 서버에 업로드
- **요청**: `changes` (created/updated/deleted)
- **응답**: 성공/실패 상태

## 트러블슈팅

### 동기화가 멈춤

- **원인**: 동시성 제어 또는 네트워크 오류
- **해결**: 앱 재시작 또는 수동 동기화 버튼

### 데이터 불일치

- **원인**: 동기화 중단 또는 서버 오류
- **해결**: checkSync 실행 → 불일치 시 전체 재동기화

### 속도 느림

- **원인**: 대량 데이터 또는 네트워크 불안정
- **해결**:
    - 배치 크기 조정
    - 불필요한 데이터 삭제
    - WiFi 환경에서 동기화

## 디버깅

### 로깅 활성화

```bash
# 브라우저 콘솔
localStorage.debug = 'sync'
```

### Sentry 확인

> **선택적 기능**: `NEXT_PUBLIC_ENABLE_SENTRY=true` 설정 시 활성화됩니다.

- Breadcrumb 추적으로 동기화 흐름 확인
- 에러 발생 시 상세 컨텍스트 확인

## 주요 파일

- `src/watermelondb/sync.ts` - 동기화 메인 로직
- `src/functions/hooks/useSync.tsx` - React 훅
- `app/api/sync/pull/route.ts` - Pull 엔드포인트
- `app/api/sync/push/route.ts` - Push 엔드포인트

## 관련 문서

- [기능 명세 - 데이터 동기화](../meta-guides/functionality.md#데이터-동기화)
