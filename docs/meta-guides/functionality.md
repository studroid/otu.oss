# 애플리케이션 기능 목록

## 사용자 관리

- 회원가입 및 로그인
- 사용자 프로필 관리
- 보호된 경로 접근 시 로그인 후 원래 페이지로 복귀: 비로그인 상태에서 `/home` 하위 경로 접근 시 `/signin?redirectTo=[원래경로]`로 이동하고, 로그인 성공 후 `redirectTo`로 복귀
- 소셜 로그인 완료 시 로그인 요청을 시작한 현재 서비스 호스트로 자동 복귀 (멀티 호스트 환경 대응, 프록시 환경 지원)
- 신규 사용자 온보딩: 최초 로그인 시 사용자 로케일에 맞는 샘플 페이지 자동 생성 (멱등 처리로 중복 방지, BlockNote 블록 ID 포함)

## 핵심 기능

### 편집 기능

- BlockNote 에디터 기반 리치 텍스트 편집
- 에디터 다국어 지원 (한국어/영어)
- **AI 통합 에디터: BlockNote XL-AI 확장을 통한 고급 AI 기능**
    - **AI 포맷팅 툴바: 텍스트 선택 시 AI 개선/변경 버튼 표시**
    - **AI 슬래시 메뉴: "/" 입력 시 AI 관련 명령어 옵션 제공**
    - **AI 명령 메뉴: 텍스트 개선, 요약, 번역, 스타일 변경 등 다양한 AI 기능**
    - **OpenAI GPT-4o 모델 기반 텍스트 처리**
    - **프록시 API를 통한 보안 API 호출 (클라이언트 측 API 키 노출 방지)**
    - **AI 기능 조건부 활성화: 에디터에 AI model이 주입되었는지 자동 감지하여 AI 관련 UI 요소들을 조건적으로 표시**
- **AI 이미지 캡셔닝: 비용 효율적인 2단계 처리 방식**
    - **저해상도 1차 분석: 이미지 제목, 설명, 텍스트 유무 및 고해상도 처리 필요성 판단**
    - **고해상도 2차 처리: 텍스트가 불분명하거나 많거나 중요한 경우에만 OCR 수행**
    - **EXIF 좌표 정보 추출 및 Google Maps 임베딩 자동 생성**
    - **사용자 커스텀 프롬프트 지원 및 다국어 출력**
- 커스텀 슬래시 메뉴: 카드 형태의 그리드 레이아웃으로 블록 선택
- 포맷팅 툴바: 굵게, 기울임, 밑줄, 취소선, 색상, 정렬 등 텍스트 서식 기능
- 인용 기능 제거: 슬래시 메뉴에서 인용(quote) 블록 기능 비활성화 (코드: `slashMenu.ts`)
- 실시간 자동저장 (3초 간격, debounce 적용 - 연속 편집 중에는 저장되지 않고 타이핑을 멈춘 후 실행)
- 자동 제목 생성 (100글자 이상 작성 시 AI 기반)
- 수동 저장 (Cmd/Ctrl+S 단축키)
- 저장 상태 시각적 표시 (저장 중, 저장됨, 저장되지 않음)
- 저장 실패 시 자동 재시도 (최대 3회)
- 저장 버튼: 본문 내용이 있거나, 수정사항이 있거나, 제목이 있는 경우 표시
- 편집 화면 내 AI 채팅 접근: 저장 버튼 옆 원형 버튼으로 채팅 기능 바로 실행
- 제목 및 본문 길이 제한: 각각 50,000자
- **페이지 삭제 후 홈으로 리디렉션**: 페이지 삭제 시 React Router 호환 네비게이션으로 `/home` 페이지로 자동 이동

### 간단메모 (GlobalInput)

- 빠른 메모 입력 및 저장 (GlobalInput 컴포넌트)
- **연속 입력 제한 (10초)**: 마지막 입력 후 10초 이내 재입력 차단으로 과도한 반복 입력 방지 (개발 환경에서는 제한 없음)
- 기존 메모에 추가 기능 (&& 기호 사용)
- 이미지 붙여넣기 지원 (Uploadcare 통합)

### 폴더 시스템 (페이지 그룹핑)

- 폴더 생성, 수정, 삭제 (CRUD)
- 하나의 페이지는 하나의 폴더에만 속함 (1:N 관계)
- 폴더에 페이지 추가/제거 기능 (page.folder_id 직접 수정)
- 폴더별 썸네일 이미지 설정
- 폴더 설명 및 메타데이터 관리
- 폴더에 속한 페이지 수 자동 카운팅 (트리거로 관리)
- 마지막 페이지 추가 시간 자동 추적 (트리거로 관리)
- 사용자별 폴더 접근 권한 제어 (RLS)
- **페이지/폴더 버튼 그룹: 홈 화면 제일 왼쪽에 페이지와 폴더 선택 버튼을 exclusive 그룹으로 배치**
- **조건부 UI 레이아웃: 페이지 모드에서는 페이지/폴더 선택 + 그리드/리스트 전환 버튼 표시, 폴더 모드에서는 페이지/폴더 선택 버튼만 표시**
- **폴더 목록 표시: 홈 화면의 폴더 모드에서 항상 그리드 형태로 폴더들을 페이지와 동일한 디자인으로 표시**
- **페이지 목록 표시: 페이지 모드에서 그리드/리스트 전환 가능, 폴더 상세 페이지에서도 그리드/리스트 전환 가능**
- **폴더 새로 만들기: 폴더 모드에서 바로 새 폴더 생성 가능**
- **개별 폴더 보기: 폴더 선택 시 해당 폴더의 페이지 목록만 표시하는 전용 페이지 제공**
- **폴더 제목 수정: 폴더 상세 페이지에서 인라인 편집 가능 (Home2 RRD)**
    - **편집 모드: 편집 버튼 클릭 시 인라인 입력 필드/적용/취소 버튼 표시**
    - **키보드 단축키: Enter 키로 저장, Escape 키로 취소**
    - **일관된 UX: 폴더 관리 다이얼로그와 동일한 편집 인터페이스 적용**
- **폴더 관리 다이얼로그 UI 제어: 페이지가 선택되지 않은 상태에서 라디오 버튼 숨김 및 클릭 비활성화**
    - **라디오 버튼 조건부 렌더링: 페이지가 선택된 경우에만 라디오 버튼 표시**
    - **시각적 비활성화: 페이지 미선택 시 opacity 0.5 적용 및 not-allowed 커서 표시**
    - **호버 효과 제어: 페이지 선택 상태에서만 호버 효과 활성화**
- **폴더 생성 다이얼로그 분리: 폴더 생성 기능을 별도 다이얼로그로 구현**
    - **전용 폴더 생성 다이얼로그: 간단한 폴더명 입력만 지원하는 최적화된 UI**
    - **가운데 정렬 텍스트 입력 필드: 사용자 집중도 향상**
    - **하단 생성/취소 버튼: 명확한 액션 영역 구분**
    - **키보드 단축키 지원: Enter 키로 생성, ESC 키로 취소**
    - **생성 완료 시 자동 다이얼로그 닫기: 매끄러운 사용자 경험**
    - **생성 성공 시 콜백 시스템: 폴더 목록 자동 새로고침**
    - **완전 다국어 지원: 모든 텍스트 다국어 키로 처리**
- **폴더 관리 다이얼로그 개선: 기존 폴더 관리 및 페이지 할당 전용**
    - **폴더 생성 기능 제거: 별도 다이얼로그로 분리**
    - **닫기 버튼 추가: 명확한 종료 경로 제공**
    - **관리 기능에 집중: 폴더 수정, 삭제, 페이지 할당만 담당**
- **페이지 편집 화면 폴더 버튼 동작 개선 (신규)**
    - 폴더가 하나도 없는 경우: 폴더 생성 다이얼로그를 먼저 표시하고, 생성 성공 시 해당 페이지에 자동으로 폴더 지정
    - 폴더가 1개 이상 존재하는 경우: 기존처럼 폴더 관리 다이얼로그를 표시
- **폴더 추가 다이얼로그 이중 모드 지원 (2024.12 업데이트)**
    - **다중 선택 모드: 단순화된 UI로 빠른 폴더 지정 및 이동**
        - 라디오 버튼, 수정, 삭제 기능 없는 깔끔한 인터페이스
        - 폴더 클릭 시 선택된 페이지들을 추가하고 바로 해당 폴더로 이동
        - 지정안함 버튼으로 폴더에서 제거 가능
    - **개별 페이지 모드: 완전한 폴더 관리 기능 제공**
        - 라디오 버튼으로 현재 폴더 상태 표시
        - 폴더 수정 및 삭제 버튼 제공
        - 폴더 선택 시 즉시 변경 적용 (이동하지 않음)
    - **공통 기능: 폴더 생성 버튼으로 새 폴더 즉시 생성 가능**
- **다중 페이지 폴더 추가 기능: 여러 페이지를 한 번에 폴더에 추가**
    - **다중 선택 모드 폴더 버튼: 페이지 모드에서 다중 선택 시 폴더 버튼 표시**
    - **다중 페이지 폴더 추가 다이얼로그: 선택된 페이지들을 폴더에 추가하는 전용 다이얼로그**
    - **확인 프로세스: 폴더 선택 후 확인 다이얼로그로 실수 방지**
    - **선택 모드 자동 해제: 작업 완료 후 다중 선택 모드 자동 해제**
    - **실시간 페이지 수 표시: 각 폴더의 현재 페이지 수 표시**

#### 폴더 상세 (Home2 RRD) - 신규/복구

- **인라인 폴더명 수정**: 헤더에서 즉시 편집/적용/취소 가능, 저장 시 스낵바 피드백
- **폴더 삭제**: 확인 다이얼로그 후 삭제, 성공 시 스낵바 및 상위로 이동
- **정렬/뷰 모드/선택 기능 유지**: 기존 `SortControl`, `ViewModeControl`, `Selection` 통합 유지

### 검색 (Home RRD)

- **URL이 단일 진실 소스**: `/home/search/:keyword?` (상세: `/home/search/:keyword/:pageId`)
- **검색 결과 UI 재사용**: 페이지 리스트 UI(`components/home2/sections/page/Container.tsx`)를 재사용
- **Fetcher 경로 기반 파라미터 사용**: `useParams().keyword`를 그대로 `Page.list`의 `searchKeyword`로 전달
- **자연스러운 복귀 경로**: 상세 진입 시 `/home/search/:keyword/:pageId`로 이동하여 뒤로가기에 자연스럽게 복귀
- **다중 선택 및 폴더 추가**: 검색 결과에서 페이지 다중 선택 및 폴더에 추가 기능 지원

세부 동작:

- 헤더 우측의 메뉴 버튼에서 '폴더명 수정', '폴더 삭제' 노출
- 폴더명 수정 중 Enter 저장, ESC 취소, 저장 시 폴더 목록/페이지 리스트 데이터 새로고침
- 삭제 성공 시 `/home/folder`로 이동하며 햅틱 피드백 발생

### 채팅

- 텍스트 입력 및 전송
- 채팅 내역 관리 및 탐색 (화살표 키로 이전 메시지 탐색)
- RAG(Retrieval-Augmented Generation) 모드 선택 기능 (none/all/current)
- 모바일과 데스크톱 환경에서의 다른 입력 동작 지원
- 익명 사용자 제한 및 로그인 유도
- 채팅 내용 페이지로 복사 (코드 블록 포맷 보존)
- 저장한 채팅의 페이지 이동: React Router DOM 기반 즉시 내비게이션
    - 저장 완료 후 `/home/page/[id]`로 이동 시 `useNavigate` 사용
    - BrowserRouter 컨텍스트 내부에서 서버 요청 없이 클라이언트에서만 경로 전환

#### 반응형 레이아웃 (신규)

- 화면 폭이 680px 이상이고 채팅이 열려 있으면, 본문 영역이 우측으로 `drawerWidth`만큼 패딩되어 본문과 채팅이 나란히 배치됨
- 680px 미만에서는 기존처럼 채팅이 오버레이로 표시되어 본문 위에 겹쳐짐

### 페이지 공유

- 사용자 페이지 공개/비공개 전환 기능
- 공유 URL 생성 및 복사 기능
- 공유 페이지 실시간 캐시 무효화 및 업데이트
- 서버 우선 업데이트로 즉시 공유 가능
- 공유 페이지 뷰어 (제목, 내용, 날짜, 사용자 정보 표시)
- 공유 상태 변경 시 시각적 피드백 제공

### 알람 (리마인더)

- 페이지별 개별 알람 설정
- 알람 활성화/비활성화 토글
- **리마인더 티커**: 설정된 리마인더를 하단에 자동 스크롤 표시
    - 벨 아이콘과 함께 표시
    - 마우스 오버 시 일시 정지 기능
- **알람이 이미 등록된 경우에만 자동으로 푸시 권한 요청**
- **알람 활성화 시마다 네이티브 앱에 푸시 권한 요청**
- **지수적 알람 주기 (1일 → 2일 → 4일 → 8일...) 최대 256일 상한**
    - **무한 증가 방지**: 9회차 이상부터는 256일 간격으로 고정
    - **통계 데이터 유지**: sent_count는 계속 증가하여 분석 목적으로 활용
- 알람 주기 초기화 기능 ("더 자주 알림" 버튼)
- 딥링크를 통한 메모 직접 접근
- 알람 설정 확인부터 전송까지 단계별 오류 추적
- **단순화된 알람 처리 조건**: `next_alarm_time <= 현재 + 12시간` OR `sent_count = 1`로 조회 조건 단순화
- **과거 시간 보정 메커니즘**: NAT가 과거인 경우 현재 시간으로 보정 후 승수 간격 재계산
- **좀비 데이터 자동 구제**: 13시간 이상 된 과거 알람도 처리하여 정상 알람 사이클로 복귀
- **1분 간격 크론잡으로 처리**: 최초 알람과 12시간 이내 예정된 알람을 처리 (과거 알람 포함)
- **배치 notification ID 업데이트**: 푸시 알림 전송 후 성공한 알람들의 notification ID를 PostgreSQL 함수로 한 번에 업데이트

> **오픈소스 버전 참고**: 푸시 알림 전송 기능(네이티브 앱 푸시 등)은 현재 비활성화 상태입니다. 알람 데이터는 DB에 저장되며, 향후 다른 푸시 서비스 통합이 가능합니다.

## 데이터 관리

- 데이터 동기화
    - 라우트 진입 동기화: 글로벌 레이아웃에서 경로 변화를 감지해 `/home/page/[page_id]`, `/home/folder`, `/home/folder/[id]`, `/home/reminder` 진입 시 즉시 동기화 트리거
    - **동시 동기화 제어**: 대기열 방식으로 동시 동기화 에러 방지 및 race condition 해결
- 백업 및 복원
- 데이터 내보내기/가져오기

## UI/UX

- 반응형 디자인
- 브라우저 타이틀 동적 업데이트 (페이지, 폴더, 리마인더 등 컨텍스트에 맞게 표시)
- 테마 모드: 회색(gray) ↔ 흰색(white) ↔ 검정(black) 순환 토글
    - 프로필 메뉴에서 클릭 시 순환 전환
    - 현재 모드는 텍스트("회색/흰색/검정")로 표시
    - 네이티브 브릿지 payload는 light/dark로 유지(black=dark, 나머지=light)
- 다국어 지원 (한국어, 영어)
- 언어 변경 시 서드파티 서비스도 동기화
- 햅틱 피드백:
    - 안드로이드는 Web Vibration API 사용
    - iOS는 네이티브 브릿지 호출
- 빠른 페이지 전환: React Router DOM의 `useNavigate`를 통한 클라이언트 사이드 라우팅 (Home2 영역), 레거시 영역은 history API 사용
- **일관된 아이콘 사용: 전체 애플리케이션에서 heroicons 사용으로 통일**

## PWA 기능

- 오프라인 사용
- 앱 설치 가능
- 푸시 알림
- 개발자 모드: 로고 영역을 5번 연속 탭하여 전체 캐시 수동 삭제 가능

## 성능 최적화

- 빠른 로딩 시간
- 효율적인 상태 관리
- 코드 스플리팅
- **HOC 패턴을 통한 모달 컴포넌트 최적화**: 전체 화면 모달의 공통 로직 (애니메이션, 상태 관리, Pull-to-dismiss 등)을 HOC로 추상화하여 코드 중복 95% 제거
- **에디터 업데이트 최적화**: debounced 핸들러 통합으로 HTML 변환을 한 번만 수행하여 모바일 메인 스레드 블로킹 방지

## 보안

- **Supabase 인증 토큰 조각 최적화**: 불필요한 토큰 조각을 자동으로 감지하고 삭제하여 UTF-8 오류 방지
