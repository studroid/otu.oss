# E2E 테스트 가이드

## HTTP 429 에러 처리 - 수동 테스트 가이드

Issue #1085의 HTTP 429 에러 처리는 다음과 같이 수동으로 테스트할 수 있습니다.

### 사전 준비

1. **개발 서버 실행**

    ```bash
    npm run dev
    ```

2. **테스트 계정 준비**
    - 무료 플랜 계정 (사용량 한도 초과 테스트용)
    - 유료 플랜 계정 (정상 동작 확인용)

### 테스트 시나리오

#### 1. OTU 사용량 한도 초과 (USER_QUOTA_EXCEEDED)

**테스트 A: 이미지 업로드 - 제목 생성**

1. 무료 플랜 계정으로 로그인
2. 사용량을 한도까지 소진 (또는 DB에서 직접 수정)
3. 이미지 파일 업로드 시도
4. **기대 결과:**
    - 스낵바에 "월간 AI 사용량이 초과되었습니다. 다음 초기화 일자: YYYY년 MM월 DD일 (N일 남음)" 메시지 표시
    - "상세 보기" 버튼 표시
    - "상세 보기" 클릭 시 사용량 다이얼로그 표시

**테스트 B: 채팅 - AI 질문**

1. 무료 플랜 계정으로 로그인 (한도 초과 상태)
2. 채팅 열기
3. 질문 입력 후 전송
4. **기대 결과:**
    - 채팅 메시지에 "❌ 월간 AI 사용량이 초과되었습니다..." 표시
    - 스낵바에 "상세 보기" 버튼 표시

#### 2. OpenAI API 한도 초과 (EXTERNAL_SERVICE_RATE_LIMIT)

> ⚠️ 주의: 실제로 OpenAI API 한도를 초과시키기는 어렵습니다.
> 코드 레벨에서 시뮬레이션하거나, OpenAI 에러를 강제로 발생시켜야 합니다.

**시뮬레이션 방법:**

1. API 코드를 임시로 수정하여 `EXTERNAL_SERVICE_RATE_LIMIT` 반환하도록 변경

    ```typescript
    // app/api/ai/titling/route.ts (임시 수정)
    return errorResponse(
        {
            status: 429,
            errorCode: 'EXTERNAL_SERVICE_RATE_LIMIT',
            message: 'OpenAI API 할당량이 초과되었습니다. 잠시 후 다시 시도해주세요.',
        },
        e
    );
    ```

2. 이미지 업로드 또는 채팅 시도

3. **기대 결과:**
    - 스낵바에 "OpenAI API 할당량이 초과되었습니다. 잠시 후 다시 시도해주세요." 메시지 표시
    - **"상세 보기" 버튼 없음** (사용량 다이얼로그 표시 안 됨)
    - 채팅의 경우: "⚠️ OpenAI API 할당량이 초과되었습니다..." 메시지 표시

### 자동화된 테스트

자동화된 테스트는 다음 파일들을 참고하세요:

1. **Unit 테스트**

    - `src/test/usage-quota-check.test.ts` - 서버 코드 검증 (14개)

2. **API Mock 테스트**

    - `src/test/http-429-error-handling.test.ts` - 클라이언트 에러 처리 (9개)

3. **통합 테스트**
    - `src/test/api-integration-429-handling.test.ts` - 전체 플로우 검증 (12개)

### 체크리스트

#### OTU 사용량 한도 초과

- [ ] 이미지 업로드 시 한도 초과 메시지 표시
- [ ] "상세 보기" 버튼 표시
- [ ] "상세 보기" 클릭 → 사용량 다이얼로그 표시
- [ ] 다이얼로그에 리셋 날짜 표시
- [ ] 채팅에서 ❌ 아이콘과 에러 메시지 표시

#### OpenAI API 한도 초과

- [ ] 재시도 안내 메시지 표시
- [ ] "상세 보기" 버튼 **미표시**
- [ ] 채팅에서 ⚠️ 아이콘과 에러 메시지 표시

#### 기타

- [ ] 에러 로깅이 콘솔에 올바르게 출력됨
- [ ] 네트워크 오류 시 적절한 에러 처리
- [ ] 타입 체크 통과
- [ ] 모든 자동화 테스트 통과

### 디버깅

문제가 발생하면:

1. **브라우저 개발자 도구 확인**

    ```javascript
    // 콘솔에서 디버그 로그 활성화
    localStorage.debug = 'chat,uploader,ai';
    ```

2. **네트워크 탭 확인**

    - API 응답의 `status` 코드 확인
    - `errorCode` 또는 `code` 필드 값 확인
    - 응답 메시지 확인

3. **서버 로그 확인**
    - UsageService.checkQuota 로그
    - API 에러 로그

### 관련 이슈

- Issue #1085: HTTP 429 사용 정책 개선
- Issue #779: 사용량 체크 기능 점검
